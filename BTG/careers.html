<script>
async function submitJobApplication(form) {
  const msg = document.getElementById("msg");
  const btn = document.getElementById("btn-submit");
  const fileInput = document.getElementById("cv");
  const file = fileInput.files[0];

  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzAwpODbP9ttyr4XTpbVLWifhTimlxTXENaAmzehIehFUFoYcB5D62jNN-Jt8bKT78l/exec";

  btn.disabled = true;
  btn.innerText = "Uploading...";
  msg.style.display = "none";

  try {
    if (!file) throw new Error("Please upload your CV as a PDF.");
    if (file.type !== "application/pdf") throw new Error("PDF files only.");
    if (file.size > 2 * 1024 * 1024) throw new Error("File too large. Max 2MB.");

    const base64 = await new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(String(r.result).split(",")[1]);
      r.onerror = () => reject(new Error("Failed to read file."));
      r.readAsDataURL(file);
    });

    const payload = {
      name: (form.name.value || "").trim(),
      email: (form.email.value || "").trim(),
      phone: (form.phone.value || "").trim(),
      mall_pref: form.mall_pref.value,
      applied_role: document.getElementById("target-role").value,
      cv_filename: file.name,
      cv_base64: base64
    };

    // KEY CHANGE: text/plain avoids CORS preflight that breaks Apps Script
    const res = await fetch(WEB_APP_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(payload),
      redirect: "follow"
    });

    const raw = await res.text();
    let data;
    try { data = JSON.parse(raw); }
    catch { throw new Error("Server returned non-JSON: " + raw.slice(0, 180)); }

    if (!data.success) throw new Error(data.error || "Unknown server error");

    msg.innerText = "✅ Application submitted successfully!";
    msg.style.color = "green";
    form.reset();

  } catch (err) {
    msg.innerText = "❌ " + (err.message || "Load failed");
    msg.style.color = "red";
    console.error(err);
  } finally {
    msg.style.display = "block";
    btn.disabled = false;
    btn.innerText = "Submit";
  }
}
</script>
